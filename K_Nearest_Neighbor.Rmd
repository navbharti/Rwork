---
title: "knn"
author: "Dr. Naveen Kumar"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## The Dataset

```{r}
# Loading data
data(iris)

# Structure 
str(iris)
```
## Performing KNN in R


```{r}
# Installing Packages 
install.packages("e1071", repos = "http://cran.us.r-project.org") 
install.packages("caTools", repos = "http://cran.us.r-project.org") 
install.packages("class", repos = "http://cran.us.r-project.org") 

# Loading package 
library(e1071) 
library(caTools) 
library(class) 

# Loading data 
data(iris) 
head(iris)
```

## Splitting data into train and test data

```{r}
# Splitting data into train and test data 
split <- sample.split(iris, SplitRatio = 0.7) 
train_cl <- subset(iris, split == "TRUE") 
test_cl <- subset(iris, split == "FALSE") 

# Feature Scaling 
train_scale <- scale(train_cl[, 1:4]) 
test_scale <- scale(test_cl[, 1:4]) 


head(train_scale)
head(test_scale)
```

## Fitting KNN Model

```{r}
# Fitting KNN Model to training dataset 
classifier_knn <- knn(train = train_scale, 
					test = test_scale, 
					cl = train_cl$Species, 
					k = 1) 
classifier_knn 
```

## Confusin Matrix

```{r}
# Confusiin Matrix 
cm <- table(test_cl$Species, classifier_knn) 
cm 

```

## Model Evaluation for different K values

```{r}
# Model Evaluation - Choosing K 
# Calculate out of Sample error 
misClassError <- mean(classifier_knn != test_cl$Species) 
print(paste('Accuracy =', 1-misClassError)) 

# K = 3 
classifier_knn <- knn(train = train_scale, 
					test = test_scale, 
					cl = train_cl$Species, 
					k = 3) 
misClassError <- mean(classifier_knn != test_cl$Species) 
print(paste('Accuracy =', 1-misClassError)) 

# K = 5 
classifier_knn <- knn(train = train_scale, 
					test = test_scale, 
					cl = train_cl$Species, 
					k = 5) 
misClassError <- mean(classifier_knn != test_cl$Species) 
print(paste('Accuracy =', 1-misClassError)) 

# K = 7 
classifier_knn <- knn(train = train_scale, 
					test = test_scale, 
					cl = train_cl$Species, 
					k = 7) 
misClassError <- mean(classifier_knn != test_cl$Species) 
print(paste('Accuracy =', 1-misClassError)) 

# K = 15 
classifier_knn <- knn(train = train_scale, 
					test = test_scale, 
					cl = train_cl$Species, 
					k = 15) 
misClassError <- mean(classifier_knn != test_cl$Species) 
print(paste('Accuracy =', 1-misClassError)) 

# K = 19 
classifier_knn <- knn(train = train_scale, 
					test = test_scale, 
					cl = train_cl$Species, 
					k = 19) 
misClassError <- mean(classifier_knn != test_cl$Species) 
print(paste('Accuracy =', 1-misClassError))
```

## Plotring

```{r}

library(ggplot2)

# Data preparation
k_values <- c(1, 3, 5, 7, 15, 19)

# Calculate accuracy for each k value
accuracy_values <- sapply(k_values, function(k) {
classifier_knn <- knn(train = train_scale, 
						test = test_scale, 
						cl = train_cl$Species, 
						k = k)
1 - mean(classifier_knn != test_cl$Species)
})

# Create a data frame for plotting
accuracy_data <- data.frame(K = k_values, Accuracy = accuracy_values)

# Plotting
ggplot(accuracy_data, aes(x = K, y = Accuracy)) +
geom_line(color = "lightblue", size = 1) +
geom_point(color = "lightgreen", size = 3) +
labs(title = "Model Accuracy for Different K Values",
	x = "Number of Neighbors (K)",
	y = "Accuracy") +
theme_minimal()
```





##### Chapter 3: Classification using Nearest Neighbors --------------------

## Example: Classifying Cancer Samples ----
## Step 2: Exploring and preparing the data ---- 
# import the CSV file

```{r}
wbcd <- read.csv("data/wisc_bc_data.csv")
```


# examine the structure of the wbcd data frame
```{r}
str(wbcd)
```

# drop the id feature
```{r}
wbcd <- wbcd[-1]
```

# table of diagnosis
```{r}
table(wbcd$diagnosis)
```


# recode diagnosis as a factor
```{r}
wbcd$diagnosis <- factor(wbcd$diagnosis, levels = c("B", "M"),
                         labels = c("Benign", "Malignant"))
```

# table or proportions with more informative labels

```{r}
round(prop.table(table(wbcd$diagnosis)) * 100, digits = 1)
```

# summarize three numeric features

```{r}
summary(wbcd[c("radius_mean", "area_mean", "smoothness_mean")])
```

# create normalization function

```{r}
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}
```

# test normalization function - result should be identical

```{r}
normalize(c(1, 2, 3, 4, 5))
normalize(c(10, 20, 30, 40, 50))
```

# normalize the wbcd data

```{r}
wbcd_n <- as.data.frame(lapply(wbcd[2:31], normalize))
```

# confirm that normalization worked

```{r}
summary(wbcd_n$area_mean)
```

# create training and test data
```{r}
wbcd_train <- wbcd_n[1:469, ]
wbcd_test <- wbcd_n[470:569, ]
```

# create labels for training and test data
```{r}
wbcd_train_labels <- wbcd[1:469, 1]
wbcd_test_labels <- wbcd[470:569, 1]
```

## Step 3: Training a model on the data ----
# load the "class" library

```{r}
library(class)

wbcd_test_pred <- knn(train = wbcd_train, test = wbcd_test,
                      cl = wbcd_train_labels, k = 21)
```

## Step 4: Evaluating model performance ----

# load the "gmodels" library

```{r}
library(gmodels)
```
# Create the cross tabulation of predicted vs. actual
```{r}
CrossTable(x = wbcd_test_labels, y = wbcd_test_pred,
           prop.chisq = FALSE)
```

## Step 5: Improving model performance ----

# use the scale() function to z-score standardize a data frame

```{r}
wbcd_z <- as.data.frame(scale(wbcd[-1]))
```

# confirm that the transformation was applied correctly

```{r}
summary(wbcd_z$area_mean)
```

# create training and test datasets

```{r}
wbcd_train <- wbcd_z[1:469, ]
wbcd_test <- wbcd_z[470:569, ]
```

# re-classify test cases
```{r}
wbcd_test_pred <- knn(train = wbcd_train, test = wbcd_test,
                      cl = wbcd_train_labels, k = 21)
```

# Create the cross tabulation of predicted vs. actual

```{r}
CrossTable(x = wbcd_test_labels, y = wbcd_test_pred,
           prop.chisq = FALSE)
```

# try several different values of k
```{r}

wbcd_train <- wbcd_n[1:469, ]
wbcd_test <- wbcd_n[470:569, ]

k_values <- c(1, 5, 11, 15, 21, 27)
```

# for loop to test all k values in k_values vector
```{r}

for (k_val in k_values) {
  wbcd_test_pred <- knn(train = wbcd_train,
                        test = wbcd_test,
                        cl = wbcd_train_labels,
                        k = k_val)
  CrossTable(x = wbcd_test_labels,
             y = wbcd_test_pred,
             prop.chisq = FALSE)
}

```